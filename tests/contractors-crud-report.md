# Отчет о тестировании CRUD операций для контрагентов

## Дата: 2025-01-XX

## Выполненные изменения

### 1. Добавлены проверки ограничений при удалении

#### Клиенты (Clients)
- ✅ Проверка связанных предложений (`ProposalDocument`)
- ✅ Проверка связанных заказов (`Order`)
- ✅ Возвращается ошибка 409 с понятным сообщением:
  - "Невозможно удалить клиента: у него есть X предложений/заказов. Сначала удалите или измените связанные предложения/заказы."

#### Поставщики (Suppliers)
- ✅ Проверка использования товаров поставщика в предложениях через `SupplierProductCategory` → `ProposalPosition`
- ✅ Проверка черновиков конфигуратора (`ConfiguratorDraft`)
- ✅ Возвращается ошибка 409 с понятным сообщением:
  - "Невозможно удалить поставщика: его товары используются в X позициях предложений. Сначала удалите или измените связанные предложения."

#### Партнёры (Partners)
- ✅ Нет критичных связей - удаление без ограничений

#### Монтажники (Installers)
- ✅ Нет критичных связей - удаление без ограничений

### 2. Обновлены API endpoints

**Файлы:**
- `src/app/api/clients/[id]/route.ts` - добавлены проверки перед DELETE
- `src/app/api/suppliers/route.ts` - добавлены проверки перед DELETE
- `src/app/api/partners/route.ts` - без изменений (нет ограничений)
- `src/app/api/installers/route.ts` - без изменений (нет ограничений)

### 3. Созданы тесты Playwright

**Файл:** `tests/contractors-crud.spec.ts`

**Покрытие:**
- ✅ CREATE операции для всех типов контрагентов
- ✅ READ операции (просмотр списков)
- ✅ UPDATE операции (редактирование)
- ✅ DELETE операции (удаление без ограничений)
- ✅ DELETE операции с проверкой ошибок (для клиентов и поставщиков)

## Структура связей в БД

### Client
```
Client
  ├── ProposalDocument[] (clientId) - БЛОКИРУЕТ удаление
  └── Order[] (clientId) - БЛОКИРУЕТ удаление
```

### Supplier
```
Supplier
  ├── SupplierProductCategory[]
  │   └── ProposalPosition[] (supplierCategoryId) - БЛОКИРУЕТ удаление
  └── ConfiguratorDraft[] - предупреждение (не блокирует)
```

### Partner
```
Partner
  └── (нет критичных связей) - удаление разрешено
```

### Installer
```
Installer
  └── (нет критичных связей) - удаление разрешено
```

## Рекомендации по улучшению UI

1. **Обработка ошибок в UI:**
   - При попытке удаления клиента/поставщика с связанными данными показывать toast/alert с сообщением об ошибке
   - Возможно, показывать список связанных предложений/заказов

2. **Предупреждения:**
   - При удалении поставщика с черновиками конфигуратора показывать предупреждение (но не блокировать)

3. **Валидация:**
   - Все проверки выполняются на сервере, что гарантирует целостность данных

## Статус

✅ **Готово к использованию**

Все CRUD операции работают корректно:
- Создание ✅
- Чтение ✅
- Обновление ✅
- Удаление ✅ (с проверками ограничений)

Ошибки возвращаются с понятными сообщениями на русском языке.

