name: ðŸ§ª Deploy to Staging

on:
  push:
    branches:
      - develop

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Staging via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FASTPANEL_HOST }}
          username: ${{ secrets.FASTPANEL_USER }}
          port: ${{ secrets.FASTPANEL_PORT }}
          key: ${{ secrets.FASTPANEL_SSH_KEY }}
          script: |
            set -e  # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸ§ª STAGING DEPLOYMENT STARTED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ staging
            STAGING_DIR="/var/www/fastuser/data/www/staging.infissi.omoxsoft.com.ua"
            
            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            cd $STAGING_DIR
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PM2 Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
            echo "1ï¸âƒ£ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ staging Ð¿Ñ€Ð¾Ñ†ÐµÑÑ..."
            pm2 stop punto-infissi-crm-staging || true
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· GitHub
            echo "2ï¸âƒ£ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· GitHub..."
            git fetch origin
            git reset --hard origin/develop
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ next.config.js (Ð²ÑÐµÐ³Ð´Ð° Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°ÐµÐ¼)
            echo "3ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ next.config.js..."
            cat > next.config.js << 'EOFCONFIG'
            /** @type {import("next").NextConfig} */
            const nextConfig = {
              typescript: {
                ignoreBuildErrors: true,
              },
              eslint: {
                ignoreDuringBuilds: true,
              },
            };
            module.exports = nextConfig;
            EOFCONFIG
            echo "âœ… next.config.js ÑÐ¾Ð·Ð´Ð°Ð½"
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            echo "4ï¸âƒ£ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
            npm install
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Prisma Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
            echo "5ï¸âƒ£ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Prisma Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸..."
            npx prisma migrate deploy
            npx prisma generate
            
            # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
            echo "6ï¸âƒ£ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
            rm -rf .next
            npm run build
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PM2 Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
            echo "7ï¸âƒ£ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ staging Ð¿Ñ€Ð¾Ñ†ÐµÑÑ..."
            pm2 delete punto-infissi-crm-staging || true
            pm2 start npm --name "punto-infissi-crm-staging" -- start -- --port 3002
            pm2 save
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            echo "8ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ..."
            sleep 5
            pm2 list | grep staging
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… STAGING DEPLOYMENT COMPLETED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ¥ Health Check
        run: |
          echo "Ð–Ð´ÐµÐ¼ 10 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
          sleep 10
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ staging..."
          curl -f http://95.67.11.37:3002 || exit 1
          echo "âœ… Staging Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"

