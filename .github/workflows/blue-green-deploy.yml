name: Blue-Green Deploy to FastPanel

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Create deployment archive
      run: |
        cd ..
        tar -czf punto-infissi-crm-deploy.tar.gz \
          --exclude='punto-infissi-crm/node_modules' \
          --exclude='punto-infissi-crm/.git' \
          --exclude='punto-infissi-crm/.next/cache' \
          --exclude='punto-infissi-crm/*.log' \
          --exclude='punto-infissi-crm/*.tar.gz' \
          punto-infissi-crm/
        mv punto-infissi-crm-deploy.tar.gz punto-infissi-crm/
          
    - name: Deploy to FastPanel (Blue-Green)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FASTPANEL_HOST }}
        username: ${{ secrets.FASTPANEL_USER }}
        port: ${{ secrets.FASTPANEL_PORT }}
        key: ${{ secrets.FASTPANEL_SSH_KEY }}
        script: |
          cd /var/www/fastuser/data/www/infissi.omoxsoft.com.ua
          
          # Определяем текущую и новую версии
          if [ -d "current" ]; then
            CURRENT_VERSION="current"
            NEW_VERSION="staging"
          else
            CURRENT_VERSION="staging"
            NEW_VERSION="current"
          fi
          
          echo "Current: $CURRENT_VERSION, New: $NEW_VERSION"
          
          # Создаем директорию для новой версии
          mkdir -p $NEW_VERSION
          
    - name: Upload files
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.FASTPANEL_HOST }}
        username: ${{ secrets.FASTPANEL_USER }}
        port: ${{ secrets.FASTPANEL_PORT }}
        key: ${{ secrets.FASTPANEL_SSH_KEY }}
        source: "punto-infissi-crm-deploy.tar.gz"
        target: "/var/www/fastuser/data/www/infissi.omoxsoft.com.ua/$NEW_VERSION/"
        
    - name: Build and test new version
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FASTPANEL_HOST }}
        username: ${{ secrets.FASTPANEL_USER }}
        port: ${{ secrets.FASTPANEL_PORT }}
        key: ${{ secrets.FASTPANEL_SSH_KEY }}
        script: |
          cd /var/www/fastuser/data/www/infissi.omoxsoft.com.ua
          
          # Определяем версии
          if [ -d "current" ]; then
            NEW_VERSION="staging"
          else
            NEW_VERSION="current"
          fi
          
          cd $NEW_VERSION
          
          # Extract archive
          tar -xzf punto-infissi-crm-deploy.tar.gz
          mv punto-infissi-crm/* . 2>/dev/null || true
          mv punto-infissi-crm/.* . 2>/dev/null || true
          rmdir punto-infissi-crm 2>/dev/null || true
          rm punto-infissi-crm-deploy.tar.gz
          
          # Install dependencies
          npm ci --production
          npm install @tailwindcss/postcss tailwindcss postcss autoprefixer --save-dev
          
          # Create next.config.js
          cat > next.config.js << 'EOF'
          /** @type {import('next').NextConfig} */
          const nextConfig = {
            typescript: {
              ignoreBuildErrors: true,
            },
            eslint: {
              ignoreDuringBuilds: true,
            },
          };
          module.exports = nextConfig;
          EOF
          
          # Build project
          npm run build
          
          echo "New version built successfully!"
          
    - name: Switch to new version (Zero-downtime)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FASTPANEL_HOST }}
        username: ${{ secrets.FASTPANEL_USER }}
        port: ${{ secrets.FASTPANEL_PORT }}
        key: ${{ secrets.FASTPANEL_SSH_KEY }}
        script: |
          cd /var/www/fastuser/data/www/infissi.omoxsoft.com.ua
          
          # Определяем версии
          if [ -d "current" ]; then
            CURRENT_VERSION="current"
            NEW_VERSION="staging"
            NEW_PORT="3001"
            CURRENT_PORT="3000"
          else
            CURRENT_VERSION="staging"
            NEW_VERSION="current"
            NEW_PORT="3000"
            CURRENT_PORT="3001"
          fi
          
          echo "Switching from $CURRENT_VERSION to $NEW_VERSION"
          
          # Запускаем новую версию на другом порту
          cd $NEW_VERSION
          pm2 start npm --name "punto-infissi-crm-$NEW_VERSION" -- start -- --port $NEW_PORT
          
          # Ждем запуска новой версии
          sleep 10
          
          # Проверяем что новая версия работает
          if curl -f http://localhost:$NEW_PORT > /dev/null 2>&1; then
            echo "New version is working!"
            
            # Обновляем Nginx конфигурацию (если нужно)
            # sudo cp nginx-config.conf /etc/nginx/sites-available/infissi.omoxsoft.com.ua
            
            # Перезапускаем Nginx
            # sudo systemctl reload nginx
            
            # Останавливаем старую версию
            pm2 stop punto-infissi-crm-$CURRENT_VERSION || true
            pm2 delete punto-infissi-crm-$CURRENT_VERSION || true
            
            echo "Switch completed successfully!"
          else
            echo "New version failed! Keeping old version."
            pm2 stop punto-infissi-crm-$NEW_VERSION || true
            pm2 delete punto-infissi-crm-$NEW_VERSION || true
            exit 1
          fi
