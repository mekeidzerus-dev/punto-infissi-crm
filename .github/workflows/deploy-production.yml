name: üöÄ Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy-production:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üöÄ Deploy to Production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FASTPANEL_HOST }}
          username: ${{ secrets.FASTPANEL_USER }}
          port: ${{ secrets.FASTPANEL_PORT }}
          key: ${{ secrets.FASTPANEL_SSH_KEY }}
          script: |
            set -e

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üöÄ PRODUCTION DEPLOYMENT"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            PRODUCTION_DIR="/var/www/fastuser/data/www/infissi.omoxsoft.com.ua"

            cd $PRODUCTION_DIR

            # 1Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
            echo "1Ô∏è‚É£ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø..."
            BACKUP_DIR="/var/www/fastuser/data/backups/punto-infissi-crm"
            mkdir -p $BACKUP_DIR
            BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf $BACKUP_FILE .next package-lock.json 2>/dev/null || true
            echo "‚úÖ –ë—ç–∫–∞–ø: $BACKUP_FILE"

            # 2Ô∏è‚É£ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2
            echo "2Ô∏è‚É£ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º production..."
            pm2 stop punto-infissi-crm-current || true

            # 3Ô∏è‚É£ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            echo "3Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
            if [ ! -d ".git" ]; then
              echo "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
              cd /var/www/fastuser/data/www/
              rm -rf infissi.omoxsoft.com.ua
              git clone https://github.com/mekeidzerus-dev/punto-infissi-crm.git infissi.omoxsoft.com.ua
              cd infissi.omoxsoft.com.ua
              git checkout main
            else
              echo "üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
              git fetch origin
              git reset --hard origin/main
            fi
            echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω: $(git log --oneline -1)"

            # 4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º next.config.js
            echo "4Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º next.config.js..."
            if grep -q "NODE_ENV" next.config.js; then
              echo "‚ùå –û–®–ò–ë–ö–ê: next.config.js —Å–æ–¥–µ—Ä–∂–∏—Ç NODE_ENV!"
              exit 1
            fi
            echo "‚úÖ next.config.js –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π"

            # 5Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            echo "5Ô∏è‚É£ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
            npm install
            echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

            # 6Ô∏è‚É£ Prisma –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
            echo "6Ô∏è‚É£ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Prisma..."
            echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º .env —Ñ–∞–π–ª..."
            if [ ! -f ".env" ]; then
              echo "‚ùå –û–®–ò–ë–ö–ê: .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω!"
              exit 1
            fi
            echo "‚úÖ .env —Ñ–∞–π–ª –Ω–∞–π–¥–µ–Ω"
            
            echo "üîß –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç..."
            npx prisma generate
            echo "‚úÖ Prisma –∫–ª–∏–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"

            # 7Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
            echo "7Ô∏è‚É£ –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
            rm -rf .next
            npm run build

            # 8Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º PM2
            echo "8Ô∏è‚É£ –ó–∞–ø—É—Å–∫–∞–µ–º production..."
            pm2 start npm --name "punto-infissi-crm-current" -- start -- --port 3000 || pm2 restart punto-infissi-crm-current
            pm2 save

            # 9Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            echo "9Ô∏è‚É£ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å..."
            sleep 5
            pm2 list | grep current

            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "‚úÖ PRODUCTION DEPLOYMENT COMPLETED"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      - name: üè• Health Check
        run: |
          echo "‚è≥ –ñ–¥–µ–º 15 —Å–µ–∫—É–Ω–¥..."
          sleep 15
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º production..."
          curl -f https://infissi.omoxsoft.com.ua || exit 1
          echo "‚úÖ Production —Ä–∞–±–æ—Ç–∞–µ—Ç!"
