name: ðŸš€ Deploy to Production

on:
  push:
    branches:
      - main

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FASTPANEL_HOST }}
          username: ${{ secrets.FASTPANEL_USER }}
          port: ${{ secrets.FASTPANEL_PORT }}
          key: ${{ secrets.FASTPANEL_SSH_KEY }}
          script: |
            set -e  # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð»ÑŽÐ±Ð¾Ð¹ Ð¾ÑˆÐ¸Ð±ÐºÐµ
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ðŸš€ PRODUCTION DEPLOYMENT STARTED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Ð”Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ production
            PRODUCTION_DIR="/var/www/fastuser/data/www/infissi.omoxsoft.com.ua"
            
            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
            cd $PRODUCTION_DIR
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
            echo "1ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿..."
            BACKUP_DIR="/var/www/fastuser/data/backups/punto-infissi-crm"
            mkdir -p $BACKUP_DIR
            BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            tar -czf $BACKUP_FILE .next package-lock.json 2>/dev/null || true
            echo "Ð‘ÑÐºÐ°Ð¿ ÑÐ¾Ð·Ð´Ð°Ð½: $BACKUP_FILE"
            
            # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ PM2 Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
            echo "2ï¸âƒ£ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ production Ð¿Ñ€Ð¾Ñ†ÐµÑÑ..."
            pm2 stop punto-infissi-crm-current || true
            
            # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· GitHub
            echo "3ï¸âƒ£ ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð´ Ð¸Ð· GitHub..."
            git fetch origin
            git reset --hard origin/main
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ next.config.js (Ð²ÑÐµÐ³Ð´Ð° Ð¿ÐµÑ€ÐµÑÐ¾Ð·Ð´Ð°ÐµÐ¼)
            echo "4ï¸âƒ£ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ next.config.js..."
            cat > next.config.js << 'EOFCONFIG'
            /** @type {import("next").NextConfig} */
            const nextConfig = {
              typescript: {
                ignoreBuildErrors: true,
              },
              eslint: {
                ignoreDuringBuilds: true,
              },
            };
            module.exports = nextConfig;
            EOFCONFIG
            echo "âœ… next.config.js ÑÐ¾Ð·Ð´Ð°Ð½"
            
            # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
            echo "5ï¸âƒ£ Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸..."
            npm install
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Prisma Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸
            echo "6ï¸âƒ£ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Prisma Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸..."
            npx prisma migrate deploy
            npx prisma generate
            
            # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚
            echo "7ï¸âƒ£ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚..."
            rm -rf .next
            npm run build
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ PM2 Ð¿Ñ€Ð¾Ñ†ÐµÑÑ
            echo "8ï¸âƒ£ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ production Ð¿Ñ€Ð¾Ñ†ÐµÑÑ..."
            pm2 delete punto-infissi-crm-current || true
            pm2 start npm --name "punto-infissi-crm-current" -- start -- --port 3000
            pm2 save
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            echo "9ï¸âƒ£ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ..."
            sleep 5
            pm2 list | grep current
            
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… PRODUCTION DEPLOYMENT COMPLETED"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ¥ Health Check
        run: |
          echo "Ð–Ð´ÐµÐ¼ 15 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
          sleep 15
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ production..."
          curl -f https://infissi.omoxsoft.com.ua || exit 1
          echo "âœ… Production Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚!"
          
      - name: ðŸ“¢ Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ‰ DEPLOYMENT SUCCESSFUL!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŒ Production URL: https://infissi.omoxsoft.com.ua"
          echo "ðŸ“Š Health Check: âœ… PASSED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

