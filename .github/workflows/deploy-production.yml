name: ๐ Deploy to Production

on:
  workflow_run:
    workflows: ["Pre-Deploy Check"]
    types:
      - completed
    branches:
      - main

# ะัะตะดะพัะฒัะฐัะฐะตะผ ะพะดะฝะพะฒัะตะผะตะฝะฝัะต ะทะฐะฟััะบะธ ะดะตะฟะปะพั
# ะัะฟะพะปัะทัะตะผ SHA ะบะพะผะผะธัะฐ - ะพะดะธะฝ ะดะตะฟะปะพะน ะฝะฐ ะบะพะผะผะธั, ะพัะผะตะฝัะตะผ ะฟัะตะดัะดััะธะต
concurrency:
  group: deploy-production-${{ github.event.workflow_run.head_sha }}
  cancel-in-progress: true

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    # ะะฐะฟััะบะฐะตะผ ัะพะปัะบะพ ะตัะปะธ Pre-Deploy Check ััะฟะตัะฝะพ ะทะฐะฒะตััะธะปัั
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ๐ฅ Checkout code
        uses: actions/checkout@v4
        with:
          # ะัะฟะพะปัะทัะตะผ ะบะพะผะผะธั ะธะท workflow_run ะบะพัะพััะน ะทะฐะฟัััะธะป ััะพั ะดะตะฟะปะพะน
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: ๐ Deploy to Production via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.FASTPANEL_HOST }}
          username: ${{ secrets.FASTPANEL_USER }}
          port: ${{ secrets.FASTPANEL_PORT }}
          key: ${{ secrets.FASTPANEL_SSH_KEY }}
          command_timeout: 30m
          timeout: 30m
          script: |
            set -e
            set -o pipefail

            # ะคัะฝะบัะธั ะดะปั ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ
            error_handler() {
              local exit_code=$?
              echo ""
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              echo "โ ะะจะะะะ ะะ ะญะขะะะ: $BASH_COMMAND"
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              echo "ะะพะด ะพัะธะฑะบะธ: $exit_code"
              echo "ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
              echo "ะัะพะฒะตัััะต ะปะพะณะธ ะฒััะต ะดะปั ะดะตัะฐะปะตะน ะพัะธะฑะบะธ"
              exit $exit_code
            }
            trap 'error_handler' ERR

            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ PRODUCTION DEPLOYMENT"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

            PRODUCTION_DIR="/var/www/fastuser/data/www/infissi.omoxsoft.com.ua"
            BACKUP_DIR="/var/www/fastuser/data/backups/punto-infissi-crm"

            cd $PRODUCTION_DIR

            # 1๏ธโฃ ะกะพะทะดะฐะตะผ ะฑัะบะฐะฟ
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "1๏ธโฃ ะกะะะะะะะ ะะญะะะะ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            mkdir -p $BACKUP_DIR
            BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).tar.gz"
            if [ -d ".next" ]; then
              tar -czf $BACKUP_FILE .next package-lock.json package.json 2>/dev/null || true
              if [ -f "$BACKUP_FILE" ]; then
                echo "โ ะัะบะฐะฟ ัะพะทะดะฐะฝ: $BACKUP_FILE"
                BACKUP_SIZE=$(du -h "$BACKUP_FILE" | cut -f1)
                echo "   ะะฐะทะผะตั: $BACKUP_SIZE"
              else
                echo "โ๏ธ  ะัะบะฐะฟ ะฝะต ัะพะทะดะฐะฝ (ะฒะพะทะผะพะถะฝะพ ะฟะตัะฒัะน ะดะตะฟะปะพะน)"
              fi
            else
              echo "โ๏ธ  .next ะฝะต ัััะตััะฒัะตั, ะฟัะพะฟััะบะฐะตะผ ะฑัะบะฐะฟ"
            fi

            # 2๏ธโฃ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2 ะธ ะพัะฒะพะฑะพะถะดะฐะตะผ ะฟะพัั 3000
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "2๏ธโฃ ะะกะขะะะะะะ ะะะะะะะะะะฏ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ PM2 ะฟัะพัะตัั..."
            pm2 stop punto-infissi-crm-current || true
            pm2 delete punto-infissi-crm-current || true
            sleep 2
            
            echo "๐ ะัะฒะพะฑะพะถะดะฐะตะผ ะฟะพัั 3000..."
            # ะะฐัะพะดะธะผ ะธ ัะฑะธะฒะฐะตะผ ะฟัะพัะตัั ะฝะฐ ะฟะพััั 3000
            if command -v lsof >/dev/null 2>&1; then
              lsof -ti :3000 | xargs kill -9 2>/dev/null || true
            elif command -v fuser >/dev/null 2>&1; then
              fuser -k 3000/tcp 2>/dev/null || true
            fi
            
            # ะฃะฑะธะฒะฐะตะผ ะฒัะต ะฟัะพัะตััั node/npm ะบะพัะพััะต ะผะพะณัั ะทะฐะฝะธะผะฐัั ะฟะพัั
            pkill -9 -f "next start" 2>/dev/null || true
            pkill -9 -f "node.*3000" 2>/dev/null || true
            
            sleep 2
            echo "โ ะะพัั 3000 ะพัะฒะพะฑะพะถะดะตะฝ"

            # 3๏ธโฃ ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "3๏ธโฃ ะะะะะะะะะะ ะะะะ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            if [ ! -d ".git" ]; then
              echo "๐ฅ ะะปะพะฝะธััะตะผ ัะตะฟะพะทะธัะพัะธะน..."
              cd /var/www/fastuser/data/www/
              rm -rf infissi.omoxsoft.com.ua
              git clone https://github.com/mekeidzerus-dev/punto-infissi-crm.git infissi.omoxsoft.com.ua
              cd infissi.omoxsoft.com.ua
              git checkout main
            else
              echo "๐ ะะฑะฝะพะฒะปัะตะผ ัััะตััะฒัััะธะน ัะตะฟะพะทะธัะพัะธะน..."
              git fetch origin
              git reset --hard origin/main
            fi
            
            # ะัะพะฒะตัะบะฐ ััะพ ะบะพะด ะพะฑะฝะพะฒะปะตะฝ
            LATEST_COMMIT=$(git log --oneline -1)
            echo "โ ะะพะด ะพะฑะฝะพะฒะปะตะฝ: $LATEST_COMMIT"
            
            # ะัะพะฒะตัะบะฐ ะบัะธัะธัะฝัั ัะฐะนะปะพะฒ
            CRITICAL_FILES=("package.json" "next.config.mjs" "src/lib/auth-options.ts")
            for file in "${CRITICAL_FILES[@]}"; do
              if [ ! -f "$file" ]; then
                echo "โ ะะจะะะะ: ะัะธัะธัะฝัะน ัะฐะนะป ะฝะต ะฝะฐะนะดะตะฝ: $file"
                exit 1
              fi
            done
            echo "โ ะัะต ะบัะธัะธัะฝัะต ัะฐะนะปั ะฝะฐ ะผะตััะต"

            # 4๏ธโฃ ะัะพะฒะตัะบะฐ ะบะพะฝัะธะณััะฐัะธะธ
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "4๏ธโฃ ะะะะะะะะ ะะะะคะะะฃะะะฆะะ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            if [ -f "next.config.mjs" ]; then
              if grep -q "NODE_ENV" next.config.mjs; then
                echo "โ ะะจะะะะ: next.config.mjs ัะพะดะตัะถะธั NODE_ENV!"
                exit 1
              fi
              echo "โ next.config.mjs ะฟัะฐะฒะธะปัะฝัะน"
            elif [ -f "next.config.js" ]; then
              if grep -q "NODE_ENV" next.config.js; then
                echo "โ ะะจะะะะ: next.config.js ัะพะดะตัะถะธั NODE_ENV!"
                exit 1
              fi
              echo "โ next.config.js ะฟัะฐะฒะธะปัะฝัะน"
            else
              echo "โ๏ธ  next.config ะฝะต ะฝะฐะนะดะตะฝ (ะธัะฟะพะปัะทััััั ะดะตัะพะปัะฝัะต ะฝะฐัััะพะนะบะธ)"
            fi

            # 5๏ธโฃ ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "5๏ธโฃ ะฃะกะขะะะะะะ ะะะะะกะะะะกะขะะ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐งน ะัะธัะฐะตะผ node_modules ะฟะตัะตะด ัััะฐะฝะพะฒะบะพะน..."
            # ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฟัะพัะตััั ะบะพัะพััะต ะผะพะณัั ะฑะปะพะบะธัะพะฒะฐัั ัะฐะนะปั
            pm2 stop all || true
            sleep 2
            
            # ะฃะดะฐะปัะตะผ node_modules ะตัะปะธ ะตััั ะฟัะพะฑะปะตะผั
            if [ -d "node_modules" ]; then
              echo "   ะฃะดะฐะปัะตะผ ััะฐััะน node_modules..."
              rm -rf node_modules
              echo "   โ node_modules ัะดะฐะปะตะฝ"
            fi
            
            echo "๐ฆ ะฃััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะทะฐะฒะธัะธะผะพััะธ..."
            # ะัะพะฒะตััะตะผ ะฝะฐะปะธัะธะต package-lock.json ะดะปั npm ci
            if [ -f "package-lock.json" ]; then
              echo "   ะัะฟะพะปัะทัะตะผ npm ci (ัะธััะฐั ัััะฐะฝะพะฒะบะฐ)..."
              npm ci --prefer-offline --no-audit || {
                echo "   โ๏ธ  npm ci ะฝะต ัะดะฐะปัั, ะฟัะพะฑัะตะผ npm install..."
                npm install --prefer-offline --no-audit
              }
            else
              echo "   โ๏ธ  package-lock.json ะฝะต ะฝะฐะนะดะตะฝ, ะธัะฟะพะปัะทัะตะผ npm install..."
              npm install --prefer-offline --no-audit
            fi
            
            if [ ! -d "node_modules" ]; then
              echo "โ ะะจะะะะ: node_modules ะฝะต ัะพะทะดะฐะฝ!"
              exit 1
            fi
            echo "โ ะะฐะฒะธัะธะผะพััะธ ัััะฐะฝะพะฒะปะตะฝั"

            # 6๏ธโฃ ะะฐัััะพะนะบะฐ Prisma
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "6๏ธโฃ ะะะกะขะะะะะ PRISMA"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            if [ ! -f ".env" ]; then
              echo "โ ะะจะะะะ: .env ัะฐะนะป ะฝะต ะฝะฐะนะดะตะฝ!"
              exit 1
            fi
            echo "โ .env ัะฐะนะป ะฝะฐะนะดะตะฝ"
            
            # ะัะพะฒะตัะบะฐ DATABASE_URL
            if ! grep -q "DATABASE_URL=" .env; then
              echo "โ ะะจะะะะ: DATABASE_URL ะฝะต ะฝะฐะนะดะตะฝ ะฒ .env!"
              exit 1
            fi
            echo "โ DATABASE_URL ะฝะฐะนะดะตะฝ ะฒ .env"
            
            echo "๐ง ะะตะฝะตัะธััะตะผ Prisma ะบะปะธะตะฝั..."
            npx prisma generate
            if [ ! -d "node_modules/@prisma/client" ]; then
              echo "โ ะะจะะะะ: Prisma Client ะฝะต ัะณะตะฝะตัะธัะพะฒะฐะฝ!"
              exit 1
            fi
            echo "โ Prisma ะบะปะธะตะฝั ัะณะตะฝะตัะธัะพะฒะฐะฝ"

            # 7๏ธโฃ ะกะฑะพัะบะฐ ะฟัะพะตะบัะฐ
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "7๏ธโฃ ะกะะะะะ ะะะะะะขะ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐งน ะัะธัะฐะตะผ ะบัั ะธ ััะฐััะต ัะฐะนะปั..."
            rm -rf .next
            rm -rf node_modules/.cache
            rm -rf .turbo
            echo "โ ะัั ะพัะธัะตะฝ"
            
echo "๐จ ะะฐะฟััะบะฐะตะผ ัะฑะพัะบั..."
# ะัะพะฟััะบะฐะตะผ prebuild ะดะปั ะธะทะฑะตะถะฐะฝะธั ะฟัะพะฑะปะตะผ ั esbuild ะฒ SSH ัะตััะธะธ
# prebuild ะทะฐะฟััะบะฐะตั pre-build-check ะบะพัะพััะน ะผะพะถะตั ะฒัะทัะฒะฐัั ะฟัะพะฑะปะตะผั ั esbuild
# ะัะฟะพะปัะทัะตะผ ะฟััะผัั ัะฑะพัะบั Next.js ะฑะตะท prebuild ััะบะฐ
echo "   ะัะพะฟััะบะฐะตะผ prebuild (ะผะพะถะตั ะฒัะทัะฒะฐัั ะฟัะพะฑะปะตะผั ั esbuild ะฒ SSH)..."
rm -rf .next .next/cache
echo "   ะะฐะฟััะบะฐะตะผ Next.js build ะฝะฐะฟััะผัั..."
NODE_OPTIONS="--max-old-space-size=4096" npx next build
BUILD_EXIT_CODE=$?
if [ $BUILD_EXIT_CODE -ne 0 ]; then
  echo "โ ะะจะะะะ: ะกะฑะพัะบะฐ ะฝะต ัะดะฐะปะฐัั (exit code: $BUILD_EXIT_CODE)"
  echo "๐ ะัะพะฒะตััะตะผ ะปะพะณะธ ัะฑะพัะบะธ..."
  exit 1
fi
echo "โ ะัะพะตะบั ัะพะฑัะฐะฝ ััะฟะตัะฝะพ"
            
            # ะัะพะฒะตัะบะฐ ััะพ .next ะดะธัะตะบัะพัะธั ัะพะทะดะฐะฝะฐ
            if [ ! -d ".next" ]; then
              echo "โ ะะจะะะะ: .next ะดะธัะตะบัะพัะธั ะฝะต ัะพะทะดะฐะฝะฐ ะฟะพัะปะต ัะฑะพัะบะธ!"
              exit 1
            fi
            echo "โ .next ะดะธัะตะบัะพัะธั ัะพะทะดะฐะฝะฐ"
            
            # ะัะพะฒะตัะบะฐ ััะพ ะตััั server ะดะธัะตะบัะพัะธั
            if [ ! -d ".next/server" ]; then
              echo "โ ะะจะะะะ: .next/server ะดะธัะตะบัะพัะธั ะฝะต ัะพะทะดะฐะฝะฐ!"
              exit 1
            fi
            echo "โ .next/server ะดะธัะตะบัะพัะธั ัะพะทะดะฐะฝะฐ"

            # 8๏ธโฃ ะะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "8๏ธโฃ ะะะะฃะกะ ะะะะะะะะะะฏ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "๐๏ธ  ะฃะดะฐะปัะตะผ ััะฐััะน PM2 ะฟัะพัะตัั..."
            pm2 delete punto-infissi-crm-current || true
            sleep 1
            
            echo "๐ ะะฐะฟััะบะฐะตะผ ะฝะพะฒัะน ะฟัะพัะตัั..."
            # ะฃะดะฐะปัะตะผ ััะฐััะน ะฟัะพัะตัั ะตัะปะธ ัััะตััะฒัะตั
            pm2 delete punto-infissi-crm-current || true
            sleep 2
            
            # ะัะพะฒะตััะตะผ ััะพ Next.js ะฑะธะฝะฐัะฝะธะบ ัััะตััะฒัะตั
            if [ ! -f "node_modules/.bin/next" ]; then
              echo "โ ะะจะะะะ: Next.js ะฑะธะฝะฐัะฝะธะบ ะฝะต ะฝะฐะนะดะตะฝ!"
              echo "   ะัะพะฒะตััะตะผ node_modules..."
              ls -la node_modules/.bin/ | grep next || echo "   node_modules/.bin ะฝะต ัะพะดะตัะถะธั next"
              exit 1
            fi
            
            # ะัะพััะพะน ะทะฐะฟััะบ ัะตัะตะท npm start
            echo "   ะะฐะฟััะบะฐะตะผ ัะตัะตะท npm start..."
            pm2 start npm --name "punto-infissi-crm-current" -- start -- --port 3000
            
            # ะกะพััะฐะฝัะตะผ ะบะพะฝัะธะณััะฐัะธั PM2
            pm2 save
            
            # ะฃะฑะตะถะดะฐะตะผัั ััะพ PM2 ะฝะฐัััะพะตะฝ ะฝะฐ ะฐะฒัะพะทะฐะฟััะบ
            echo "๐ ะัะพะฒะตััะตะผ ะฐะฒัะพะทะฐะฟััะบ PM2..."
            pm2 startup systemd -u $USER --hp $HOME 2>&1 | grep -v "PM2" || echo "โ๏ธ  pm2 startup ััะตะฑัะตั ะฝะฐัััะพะนะบะธ (ะฝะต ะบัะธัะธัะฝะพ)"
            
            # ะัะพะฒะตัะบะฐ ััะฐัััะฐ PM2
            sleep 3
            PM2_STATUS=$(pm2 list | grep punto-infissi-crm-current || echo "")
            if [ -z "$PM2_STATUS" ]; then
              echo "โ ะะจะะะะ: PM2 ะฟัะพัะตัั ะฝะต ะฝะฐะนะดะตะฝ!"
              pm2 logs punto-infissi-crm-current --lines 20 --nostream || true
              exit 1
            fi
            
            if echo "$PM2_STATUS" | grep -q "online"; then
              echo "โ PM2 ะฟัะพัะตัั ะทะฐะฟััะตะฝ ะธ ัะฐะฑะพัะฐะตั (online)"
            elif echo "$PM2_STATUS" | grep -q "errored\|stopped"; then
              echo "โ ะะจะะะะ: PM2 ะฟัะพัะตัั ะฒ ััะฐัััะต ะพัะธะฑะบะธ!"
              pm2 logs punto-infissi-crm-current --lines 50 --nostream
              exit 1
            else
              echo "โ๏ธ  PM2 ะฟัะพัะตัั ะทะฐะฟััะตะฝ, ะฝะพ ััะฐััั: $PM2_STATUS"
            fi

            # 9๏ธโฃ ะะฝัััะตะฝะฝัั ะฟัะพะฒะตัะบะฐ (ะฝะฐ ัะตัะฒะตัะต)
            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "9๏ธโฃ ะะะฃะขะะะะะฏะฏ ะะะะะะะะ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โณ ะะดะตะผ 15 ัะตะบัะฝะด ะดะปั ะทะฐะฟััะบะฐ ะฟัะธะปะพะถะตะฝะธั..."
            sleep 15
            
            # ะัะพะฒะตัะบะฐ ััะพ ะฟะพัั 3000 ัะปััะฐะตััั
            echo "๐ ะัะพะฒะตััะตะผ ััะพ ะฟะพัั 3000 ัะปััะฐะตััั..."
            if command -v ss >/dev/null 2>&1; then
              PORT_CHECK=$(ss -tuln | grep ":3000 " || echo "")
            elif command -v netstat >/dev/null 2>&1; then
              PORT_CHECK=$(netstat -tuln | grep ":3000 " || echo "")
            else
              PORT_CHECK=""
            fi
            
            if [ -z "$PORT_CHECK" ]; then
              echo "โ ะะจะะะะ: ะะพัั 3000 ะฝะต ัะปััะฐะตััั!"
              pm2 logs punto-infissi-crm-current --lines 50 --nostream
              exit 1
            fi
            echo "โ ะะพัั 3000 ัะปััะฐะตััั"
            
            # ะัะพะฒะตัะบะฐ health endpoint ะปะพะบะฐะปัะฝะพ
            echo "๐ฅ ะัะพะฒะตััะตะผ health endpoint ะปะพะบะฐะปัะฝะพ..."
            HEALTH_RETRIES=3
            HEALTH_SUCCESS=false
            for i in $(seq 1 $HEALTH_RETRIES); do
              if curl -f -s http://localhost:3000/api/health > /dev/null 2>&1; then
                HEALTH_RESPONSE=$(curl -s http://localhost:3000/api/health)
                echo "โ Health endpoint ะพัะฒะตัะฐะตั:"
                echo "$HEALTH_RESPONSE" | head -5
                HEALTH_SUCCESS=true
                break
              else
                echo "   ะะพะฟััะบะฐ $i/$HEALTH_RETRIES: health endpoint ะฝะต ะพัะฒะตัะฐะตั, ะถะดะตะผ 5 ัะตะบัะฝะด..."
                sleep 5
              fi
            done
            
            if [ "$HEALTH_SUCCESS" = false ]; then
              echo "โ ะะจะะะะ: Health endpoint ะฝะต ะพัะฒะตัะฐะตั ะฟะพัะปะต $HEALTH_RETRIES ะฟะพะฟััะพะบ!"
              echo ""
              echo "๐ ะะะะะะะกะขะะะ:"
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              echo "1. ะกัะฐััั PM2:"
              pm2 list
              echo ""
              echo "2. ะะตัะฐะปัะฝะฐั ะธะฝัะพัะผะฐัะธั ะพ ะฟัะพัะตััะต:"
              pm2 describe punto-infissi-crm-current 2>&1 || echo "ะัะพัะตัั ะฝะต ะฝะฐะนะดะตะฝ"
              echo ""
              echo "3. ะะพัะปะตะดะฝะธะต ะปะพะณะธ PM2 (ะพัะธะฑะบะธ):"
              pm2 logs punto-infissi-crm-current --err --lines 30 --nostream 2>&1 || echo "ะะพะณะธ ะพัะธะฑะพะบ ะฝะตะดะพัััะฟะฝั"
              echo ""
              echo "4. ะะพัะปะตะดะฝะธะต ะปะพะณะธ PM2 (ะฒัะต):"
              pm2 logs punto-infissi-crm-current --lines 50 --nostream 2>&1 || echo "ะะพะณะธ ะฝะตะดะพัััะฟะฝั"
              echo ""
              echo "5. ะัะพะฒะตัะบะฐ ะฟัะพัะตััะฐ:"
              ps aux | grep -E "node|npm|next" | grep -v grep || echo "ะัะพัะตัั Node.js ะฝะต ะฝะฐะนะดะตะฝ"
              echo ""
              echo "6. ะัะพะฒะตัะบะฐ ะฟะพััะฐ 3000:"
              (lsof -i :3000 || ss -tuln | grep 3000 || netstat -tuln | grep 3000) 2>&1 || echo "ะะพัั ะฝะต ัะปััะฐะตััั"
              echo ""
              echo "7. ะัะพะฒะตัะบะฐ ััััะบัััั ะฟัะพะตะบัะฐ:"
              ls -la .next/ 2>&1 | head -10 || echo ".next ะฝะต ัััะตััะฒัะตั"
              echo ""
              exit 1
            fi
            
            # ะัะพะฒะตัะบะฐ ััะพ ะฟัะพัะตัั ััะฐะฑะธะปะตะฝ (ะฝะต ะฟะตัะตะทะฐะฟััะบะฐะตััั)
            echo "๐ ะัะพะฒะตััะตะผ ััะฐะฑะธะปัะฝะพััั ะฟัะพัะตััะฐ..."
            sleep 5
            PM2_INFO=$(pm2 describe punto-infissi-crm-current --no-color 2>&1 || echo "")
            RESTART_COUNT=$(echo "$PM2_INFO" | grep "restart time" | grep -oE "[0-9]+" | head -1 || echo "0")
            if [ "$RESTART_COUNT" -gt 5 ]; then
              echo "โ๏ธ  ะะะะะะะะ: ะัะพัะตัั ะฟะตัะตะทะฐะฟััะบะฐะปัั $RESTART_COUNT ัะฐะท!"
              echo "๐ ะะพะณะธ ะดะปั ะฐะฝะฐะปะธะทะฐ:"
              pm2 logs punto-infissi-crm-current --lines 50 --nostream
            else
              echo "โ ะัะพัะตัั ััะฐะฑะธะปะตะฝ (ะฟะตัะตะทะฐะฟััะบะพะฒ: $RESTART_COUNT)"
            fi
            
            # ะัะพะฒะตัะบะฐ ะปะพะณะพะฒ ะฝะฐ ะบัะธัะธัะตัะบะธะต ะพัะธะฑะบะธ
            echo "๐ ะัะพะฒะตััะตะผ ะปะพะณะธ PM2 ะฝะฐ ะพัะธะฑะบะธ..."
            PM2_LOGS=$(pm2 logs punto-infissi-crm-current --lines 50 --nostream 2>&1 || echo "")
            if echo "$PM2_LOGS" | grep -qiE "error|fatal|cannot find module|EADDRINUSE|ECONNREFUSED|PrismaClient"; then
              echo "โ๏ธ  ะะฑะฝะฐััะถะตะฝั ะฒะพะทะผะพะถะฝัะต ะพัะธะฑะบะธ ะฒ ะปะพะณะฐั:"
              echo "$PM2_LOGS" | grep -iE "error|fatal|cannot find module|EADDRINUSE|ECONNREFUSED|PrismaClient" | head -15
              # ะะต ะฒััะพะดะธะผ ั ะพัะธะฑะบะพะน, ัะฐะบ ะบะฐะบ health endpoint ัะฐะฑะพัะฐะตั, ะฝะพ ะฟัะตะดัะฟัะตะถะดะฐะตะผ
            else
              echo "โ ะัะธัะธัะตัะบะธั ะพัะธะฑะพะบ ะฒ ะปะพะณะฐั ะฝะต ะพะฑะฝะฐััะถะตะฝะพ"
            fi

            # ะัะพััะฐั ัะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ
            echo ""
            echo "๐ ะคะธะฝะฐะปัะฝะฐั ะฟัะพะฒะตัะบะฐ ััะฐะฑะธะปัะฝะพััะธ..."
            sleep 5
            FINAL_STATUS=$(pm2 describe punto-infissi-crm-current --no-color 2>&1 | grep -i "status" | head -1 || echo "")
            FINAL_RESTARTS=$(pm2 describe punto-infissi-crm-current --no-color 2>&1 | grep "restart time" | grep -oE "[0-9]+" | head -1 || echo "0")
            
            if echo "$FINAL_STATUS" | grep -qi "online"; then
              echo "โ ะัะพัะตัั ััะฐะฑะธะปะตะฝ (ะฟะตัะตะทะฐะฟััะบะพะฒ: $FINAL_RESTARTS)"
            else
              echo "โ ะะจะะะะ: ะัะพัะตัั ะฝะตััะฐะฑะธะปะตะฝ: $FINAL_STATUS"
              pm2 logs punto-infissi-crm-current --lines 30 --nostream
              exit 1
            fi
            
            # ะัะพััะฐั ะฟัะพะฒะตัะบะฐ ะฒะฝะตัะฝะตะณะพ URL
            echo ""
            echo "๐ ะัะพะฒะตัะบะฐ ะฒะฝะตัะฝะตะณะพ URL..."
            PRODUCTION_URL="https://infissi.omoxsoft.com.ua"
            if curl -f -s --max-time 10 "$PRODUCTION_URL/api/health" > /dev/null 2>&1; then
              echo "โ ะะฝะตัะฝะธะน health endpoint ะพัะฒะตัะฐะตั"
            else
              echo "โ๏ธ  ะะฝะตัะฝะธะน endpoint ะฝะต ะพัะฒะตัะฐะตั (ะฒะพะทะผะพะถะฝะพ Nginx ะฝะต ะฝะฐัััะพะตะฝ)"
            fi

            echo ""
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            echo "โ ะะะฃะขะะะะะฏะฏ ะะะะะะะะ ะะะะะะจะะะ"
            echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

      - name: ๐ฅ External Health Check
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "๐ ะะะะจะะฏะฏ ะะะะะะะะ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          
          PRODUCTION_URL="https://infissi.omoxsoft.com.ua"
          
          # ะัะพััะฐั ะฟัะพะฒะตัะบะฐ health endpoint
          echo "๐ฅ ะัะพะฒะตััะตะผ health endpoint..."
          if curl -f -s --max-time 10 "$PRODUCTION_URL/api/health" > /dev/null 2>&1; then
            echo "โ Health endpoint ะพัะฒะตัะฐะตั"
            curl -s --max-time 10 "$PRODUCTION_URL/api/health" | head -5
          else
            echo "โ๏ธ  Health endpoint ะฝะต ะพัะฒะตัะฐะตั (ะฒะพะทะผะพะถะฝะพ Nginx ะฝะต ะฝะฐัััะพะตะฝ)"
          fi
          
            echo ""
            echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ"
            
            # ะะฐะฟััะบะฐะตะผ ะดะธะฐะณะฝะพััะธะบั ะตัะปะธ ะตััั ัะบัะธะฟั
            if [ -f "scripts/diagnose-server.sh" ]; then
              echo ""
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              echo "๐ ะะะะะะะกะขะะะ ะะะกะะ ะะะะะะฏ"
              echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
              bash scripts/diagnose-server.sh || echo "โ๏ธ  ะะธะฐะณะฝะพััะธะบะฐ ะทะฐะฒะตััะธะปะฐัั ั ะฟัะตะดัะฟัะตะถะดะตะฝะธัะผะธ"
            fi
