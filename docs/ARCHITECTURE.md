# Архитектура приложения MODOCRM

**Тип:** Монолитное Next.js приложение  
**Версия:** 1.4.0  
**Статус:** Production Ready

## Структура

```
Frontend (React) → API Routes → Prisma → PostgreSQL
```

## Технологии

- **Next.js 15** - App Router
- **React 19** - UI
- **Prisma 6.16.3** - ORM
- **PostgreSQL** - БД
- **TypeScript 5** - типизация
- **NextAuth 4.24** - аутентификация
- **Tailwind CSS 4** - стилизация
- **Shadcn/UI** - компоненты UI

## Модули

- Аутентификация (NextAuth)
- Клиенты (CRUD)
- Поставщики/Партнёры/Монтажники
- Категории и параметры продуктов
- Конфигуратор продуктов (V2)
  - Системные параметры размеров (Ширина×Высота)
  - Автоматический расчет площади (м²)
  - Формирование названий с локализацией
- Предложения (Proposals)
  - Умный парсер клиентов с автораспознаванием
  - Динамические статусы из БД
- Система статусов документов
  - Типы: Предложения, Заказы, Счета
  - Гибкая привязка статусов к типам
  - Управление через UI
  - Палитра 26+ цветов для статусов
  - Отображение в списках документов
  - Основной статус (isDefault): возможность назначить основной статус для каждого типа документа отдельно
  - Автоматическое назначение основного статуса при создании нового документа
  - API endpoint: `/api/document-statuses/[id]/set-default` для управления основным статусом
  - Утилита: `getDefaultDocumentStatus()` для получения основного статуса по типу документа
- PDF генерация
  - Данные компании из `/api/organization`
  - Кнопки "Scarica PDF" и "Stampa"
  - Минимальные отступы 5mm для печати

---

## Анализ улучшений

### 1. Unit-тесты (Vitest)

**Приоритет:** ⚠️ Средний (3/5)

**Что получаешь:**

- ✅ Защита от регрессий в бизнес-логике
- ✅ Быстрая проверка функций (мс вместо секунд)
- ✅ Уверенность при рефакторинге

**Стоит ли сейчас:**

- ❌ НЕТ — приложение стабильное, нет активной разработки сложной логики
- ✅ ДА — если планируешь менять расчёт цен, валидацию, HEX→RAL

**Рекомендация:** Добавить позже, когда появится сложная логика или команда

---

### 2. E2E-тесты (Playwright)

**Приоритет:** ✅ Высокий (4/5)

**Что получаешь:**

- ✅ Защита критичных путей (создание предложения, конфигуратор)
- ✅ Автоматическая проверка после деплоя
- ✅ Документация через тесты

**Стоит ли сейчас:**

- ✅ ДА — если планируешь деплой в продакшен
- ✅ ДА — защита от поломок критичных фич

**Рекомендация:** Добавить 3-5 тестов для критичных сценариев:

- Создание предложения
- Конфигуратор продукта
- CRUD клиентов

---

### 3. Типы и константы в отдельные папки

**Приоритет:** ✅ Высокий (4/5)

**Что получаешь:**

- ✅ Переиспользование типов
- ✅ Меньше дублирования
- ✅ Легче поддерживать

**Стоит ли сейчас:**

- ✅ ДА — быстрая правка, низкий риск
- ✅ Улучшит качество кода

**Рекомендация:** Сделать сейчас — 30 минут работы, сразу станет чище

**План:**

```
src/types/
  - client.ts
  - proposal.ts
  - parameter.ts
src/constants/
  - routes.ts
  - statuses.ts
```

---

### 4. Дизайн-токены (styles/tokens.ts)

**Приоритет:** ⚠️ Средний (2/5)

**Что получаешь:**

- ✅ Единые цвета/отступы в одном месте
- ✅ Легче менять тему

**Стоит ли сейчас:**

- ❌ НЕТ — уже используется Tailwind CSS (токены в globals.css)
- ✅ ДА — если планируешь менять цвета часто

**Рекомендация:** Пропустить — Tailwind уже решает эту задачу

---

### 5. Storybook

**Приоритет:** ❌ Низкий (1/5)

**Что получаешь:**

- ✅ Документация компонентов
- ✅ Изоляция для разработки

**Стоит ли сейчас:**

- ❌ НЕТ — проект небольшой, компонентов 15-20
- ❌ НЕТ — лишняя инфраструктура
- ✅ ДА — если планируется команда или много компонентов

**Рекомендация:** Пропустить — избыточно для текущего размера проекта

---

## Итоговая рекомендация

**Сделать сейчас (высокий приоритет):**

1. ✅ Вынести типы и константы (30 мин)

**Сделать после (средний приоритет):** 2. ✅ E2E-тесты для критичных сценариев (2-3 часа) 3. ⚠️ Unit-тесты для бизнес-логики (когда появится сложная логика)

**Не делать:** 4. ❌ Дизайн-токены (Tailwind решает) 5. ❌ Storybook (избыточно)

---

## Установка и запуск

### Быстрый старт

```bash
# Установка
npm install

# Настройка БД
cp env.example .env.local
# Заполнить DATABASE_URL

# Миграции
npx prisma migrate deploy

# Seed данных (опционально)
npm run seed:dev

# Запуск
npm run dev
```

Откройте: http://localhost:3000

### Production

```bash
npm run build
npm start
```

### Переменные окружения

- `DATABASE_URL` - строка подключения БД
- `NEXTAUTH_SECRET` - секрет для аутентификации
- `NEXTAUTH_URL` - URL приложения
- `CRON_SECRET` - секрет для cron jobs (очистка неактивных аккаунтов)

> Подробная документация по установке: см. `SETUP.md`
