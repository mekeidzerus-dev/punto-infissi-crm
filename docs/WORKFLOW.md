# Процесс работы приложения MODOCRM

> Этот документ объединяет информацию из WORKFLOW.md и TASK_PLAN.md

## Обзор архитектуры

**Технологии:**

- Next.js 15.5.4 (App Router, Turbopack)
- React 19
- TypeScript
- Prisma ORM 6.16.3
- PostgreSQL/SQLite
- Tailwind CSS 4
- Shadcn/UI компоненты

**Структура:**

- App Router (Next.js 15)
- Server Components + Client Components
- API Routes для backend логики
- Prisma для работы с БД

## Процесс запуска приложения

1. **Инициализация:**

   ```
   npm install          # Установка зависимостей
   npm run dev          # Запуск dev сервера
   ```

2. **Загрузка страницы:**

   - `src/app/layout.tsx` → корневой layout
   - `src/app/page.tsx` → главная страница
   - `FaviconUpdater` → динамический фавикон
   - `LogoUpdater` → динамический логотип
   - `LanguageProvider` → контекст языка (RU/IT)

3. **Навигация:**
   - `/clients` → управление клиентами
   - `/proposals` → управление предложениями
   - `/suppliers` → управление поставщиками
   - `/categories` → управление категориями
   - `/settings` → настройки системы

## Основной процесс: создание предложения

### Шаг 1: Системная информация

- Выбор статуса документа (из справочника)
- Номер предложения (автогенерация: PROP-001, PROP-002...)
- Дата предложения
- Ответственный менеджер
- Срок действия предложения

### Шаг 2: Информация о клиенте

- Autocomplete поиск клиента
- Создание нового клиента (если не найден)
- Парсинг данных клиента (телефон, email, имя)
- Валидация итальянских данных (Codice Fiscale, Partita IVA)

### Шаг 3: Добавление товаров

#### 3.1 Создание группы

- Название группы (например, "Окна из ПВХ")
- Описание группы (опционально)

#### 3.2 Добавление позиций в группу

- Открытие конфигуратора продуктов
- Выбор категории (Окна/Двери)
- Выбор поставщика
- Выбор параметров:
  - Размеры (Ширина, Высота) - системные параметры
  - Модель
  - Цвет (с конвертацией HEX → RAL)
  - Дополнительные параметры
- Автоматический расчет цены (если настроено)
- Установка дефолтной ставки НДС (из справочника, isDefault=true)
- Установка количества, скидки

#### 3.3 Расчет итогов группы

- Subtotal группы = сумма всех позиций
- Sconto группы = сумма скидок
- Totale группы = Subtotal - Sconto

### Шаг 4: Расчет общих итогов

- Subtotal = сумма всех групп
- Sconto = сумма всех скидок
- Subtotal before VAT = Subtotal - Sconto
- VAT = расчет НДС по каждой позиции
- Total = Subtotal - Sconto + VAT

**Особенности:**

- Если НДС = 0% → выделение желтым фоном "(Senza IVA)"
- Автоматический пересчет при изменении данных

### Шаг 5: Сохранение

- Валидация данных
- Сохранение в БД через `/api/proposals`
- Пересчет итогов на сервере
- Обновление списка предложений

### Шаг 6: Просмотр/Печать

- Просмотр PDF: кнопка "Anteprima"
- Печать: кнопка "Stampa" → `window.print()`
- Скачивание PDF: кнопка "Scarica PDF" → генерация через html2canvas + jsPDF

## Процесс работы с НДС

1. **Загрузка ставок НДС:**

   - API: `GET /api/vat-rates`
   - Фильтр: `isActive: true`
   - Сортировка: по проценту (asc)

2. **Определение дефолтной ставки:**

   - Поиск ставки с `isDefault: true`
   - Использование функции `getDefaultVatRate()` из `vat-utils.ts`
   - Если не найдена → используется 0%

3. **Применение НДС:**
   - При создании позиции: автоматически устанавливается дефолтная ставка
   - При создании предложения: используется дефолтная ставка для позиций без указанной ставки
   - При расчете: `vatAmount = (subtotal - discount) * (vatRate / 100)`

## Процесс работы со статусами документов

1. **Загрузка статусов:**

   - API: `GET /api/document-statuses?documentType=proposal`
   - Получение статусов для конкретного типа документа
   - Сортировка по полю `order`

2. **Отображение статусов:**

   - Цветные бейджи (цвет из БД)
   - Текст на текущем языке (nameRu/nameIt)

3. **Управление статусами:**
   - Ссылка "+ Gestisci stati" в dropdown статусов
   - Открывает модальное окно `DocumentStatusesManager`
   - Drag-and-drop для изменения порядка
   - CRUD операции для статусов

## Процесс генерации PDF

### Вариант 1: Печать (Stampa)

- `window.print()` → браузерная печать
- Использует CSS `@media print`
- Отступы: 5mm
- Размер: A4

### Вариант 2: Скачивание PDF (Scarica PDF)

1. Захват HTML элемента (`#pdf-content`)
2. Конвертация в canvas через `html2canvas`
3. Создание PDF через `jsPDF`
4. Разбиение на страницы (A4)
5. Скачивание файла `Preventivo_{number}.pdf`

## Процесс работы с данными компании

1. **Загрузка данных:**

   - API: `GET /api/organization`
   - Получение: name, phone, email, address, logoUrl

2. **Использование:**

   - В PDF документах
   - В header (логотип)
   - В footer (контакты)

3. **Обновление:**
   - Через настройки (`/settings`)
   - Сохранение в БД через `PUT /api/organization`

## Процесс работы с конфигуратором продуктов

1. **Выбор категории:**

   - Загрузка категорий из БД
   - Фильтрация по активности

2. **Выбор поставщика:**

   - Загрузка поставщиков для категории
   - Выбор supplierCategoryId

3. **Выбор параметров:**

   - Системные параметры (Ширина, Высота) → всегда видны
   - Кастомные параметры → зависят от категории
   - Типы параметров: SELECT, COLOR, TEXT, NUMBER

4. **Расчет цены:**

   - Автоматический расчет на основе параметров (если настроено)
   - Использование `calculateProductPrice()` из `price-calculator.ts`

5. **Генерация описания:**

   - Автоматическая генерация через `generateProductDescription()`
   - Формат: "Категория | Модель | Параметры | Размеры | м²"

6. **Создание позиции:**
   - Сохранение конфигурации
   - Сохранение локализованных данных (RU/IT)
   - Установка дефолтной ставки НДС

## API Endpoints

### Клиенты

- `GET /api/clients` - список клиентов
- `POST /api/clients` - создание клиента
- `PUT /api/clients/[id]` - обновление клиента
- `DELETE /api/clients/[id]` - удаление клиента

### Предложения

- `GET /api/proposals` - список предложений
- `POST /api/proposals` - создание предложения
- `PUT /api/proposals/[id]` - обновление предложения
- `DELETE /api/proposals/[id]` - удаление предложения

### НДС

- `GET /api/vat-rates` - список ставок НДС
- `POST /api/vat-rates` - создание ставки НДС
- `PUT /api/vat-rates/[id]` - обновление ставки
- `DELETE /api/vat-rates/[id]` - удаление ставки

### Статусы документов

- `GET /api/document-statuses` - список статусов
- `POST /api/document-statuses` - создание статуса
- `PUT /api/document-statuses/[id]` - обновление статуса
- `DELETE /api/document-statuses/[id]` - удаление статуса
- `PUT /api/document-status-types/[id]` - изменение порядка статуса
- `POST /api/document-status-types/reorder` - массовое изменение порядка

### Организация

- `GET /api/organization` - данные компании
- `PUT /api/organization` - обновление данных компании

## База данных

**Схема (Prisma):**

- `Client` - клиенты
- `ProposalDocument` - предложения
- `ProposalGroup` - группы товаров
- `ProposalPosition` - позиции товаров
- `ProductCategory` - категории продуктов
- `Supplier` - поставщики
- `VATRate` - ставки НДС
- `DocumentStatus` - статусы документов
- `DocumentType` - типы документов
- `Organization` - данные компании

**Миграции:**

- `npx prisma migrate dev` - создание миграции
- `npx prisma migrate deploy` - применение миграций

**Seed:**

- `npm run seed:dev` - заполнение тестовыми данными

## Процесс деплоя

1. **Подготовка:**

   ```bash
   npm run build          # Проверка сборки
   npm run lint          # Проверка линтера
   ```

2. **Миграции БД:**

   ```bash
   npx prisma migrate deploy
   ```

3. **Запуск:**

   ```bash
   npm start             # Production сервер
   ```

4. **Проверка:**
   - Проверить доступность приложения
   - Проверить работу API endpoints
   - Проверить работу PDF генерации

---

## План выполнения задач

### ✅ Задача 1: Вынести типы и константы - ЗАВЕРШЕНО

**Структура:**
```
src/types/
  - client.ts      - типы клиентов
  - proposal.ts     - типы предложений
  - parameter.ts    - типы параметров
  - supplier.ts     - типы поставщиков
  - common.ts       - общие типы (VATRate, ProductCategory)
src/constants/
  - routes.ts       - API маршруты
  - statuses.ts     - статусы
```

**Выполнено:**
- ✅ Созданы папки и файлы
- ✅ Вынесены типы из proposal-form-v3.tsx
- ✅ Обновлены импорты

### Задача 2: Тестирование

1. Перезапуск приложения
2. Проверка компиляции (npm run build)
3. Проверка основных функций
4. Ручные тесты

### Задача 3: Анализ конфигуратора

**Цель конфигуратора:**
Пользователь заполняет параметры → нажимает "Conferma" → товар появляется в документе предложения с заполненными параметрами и рассчитанной ценой.

**Текущий поток:**
1. Шаг 1: Выбор категории → `handleCategorySelect`
2. Шаг 2: Выбор поставщика → `handleSupplierSelect`
3. Шаг 3: Заполнение параметров → `ParametersConfiguration`
4. Нажатие "Conferma" → `handleConfigurationComplete`
5. Создание product объекта с конфигурацией
6. Расчет цены через `calculateProductPrice`
7. Создание `ProposalPosition` с параметрами
8. Добавление в `formData.groups[currentGroupIndex].positions`
