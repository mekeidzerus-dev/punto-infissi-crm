# История релизов и исправлений

## Релиз 1.4.1 - 2025-12-06

**Автор:** MekeidzeRH

**Новые возможности:**
- Восстановление пароля без email сервиса
  - Токены восстановления отображаются прямо в интерфейсе (dev режим / без email)
  - Полная ссылка для сброса пароля доступна для копирования
  - Удобные кнопки копирования токена и ссылки
  - Прямой переход на страницу сброса пароля
  - Автоматическое определение режима работы (dev/production с email/без email)

**Исправления:**
- Исправлены все проваленные тесты авторизации (100% прохождение)
- Улучшена обработка rate limiting в тестах
- Оптимизирована структура документации (удалены дубликаты и временные файлы)
- **КРИТИЧНО:** Исправлена проблема с webpack chunks в dev режиме
  - Вынесен `authOptions` в отдельный файл (`src/lib/auth-options.ts`)
  - Добавлен `dynamic = 'force-dynamic'` в profile route
  - Создан `next.config.mjs` с правильными настройками webpack
  - Добавлен автоматический prebuild hook для очистки кэша

**Технические изменения:**
- Обновлен `src/app/auth/forgot-password/page.tsx` - улучшенный UI с отображением токенов
- Обновлен `src/app/api/auth/forgot-password/route.ts` - поддержка режима без email
- Создан `src/lib/auth-options.ts` - вынесена конфигурация NextAuth
- Создан `next.config.mjs` - настройки webpack для стабильной сборки
- Создан `scripts/pre-build-check.ts` - проверка перед сборкой
- Добавлен скрипт `npm run clean` - очистка кэша
- Обновлен `package.json` - добавлен `prebuild` hook
- Создан `docs/BUILD-TROUBLESHOOTING.md` - документация по решению проблем сборки
- Создан `.github/workflows/pre-deploy-check.yml` - автоматическая проверка перед деплоем

**Тестирование:**
- ✅ Все тесты авторизации пройдены (9/9 - 100%)
- ✅ Тесты восстановления пароля без email пройдены (7/7 - 100%)

**Документация:**
- Обновлен `RELEASES.md` - добавлена информация о версии 1.4.1
- Обновлен `AUTH-COMPLETE.md` - добавлена информация о восстановлении без email
- Обновлен `README.md` - оптимизирована структура документации

---

## Релиз 1.4.0 - 2025-11-03
**Автор:** MekeidzeRH

**Новые возможности:**
- Функция основного статуса (isDefault) для документов
  - Возможность назначить любой статус как основной для каждого типа документа отдельно
  - Автоматическое назначение основного статуса при создании нового документа
  - Визуальная индикация основного статуса зеленым badge с иконкой звезды
  - Статусы остаются на своих местах (без автоматической сортировки наверх)
- Улучшения UI управления статусами:
  - Toast-уведомления вместо всплывающих окон (alert)
  - Зеленый badge для основного статуса
  - Кнопка со звездой для установки/снятия пометки "основной"

**Исправления:**
- Заменены все console.log/error/warn на logger во всех компонентах
- Удалены временные отладочные файлы

**Технические изменения:**
- Добавлено поле `isDefault` в модель `DocumentStatusType` (Prisma schema)
- Создан новый API endpoint `/api/document-statuses/[id]/set-default` для управления основным статусом
- Создана утилита `getDefaultDocumentStatus()` в `src/lib/document-status-utils.ts`
- Обновлен API `/api/document-statuses` - возвращает поле `isDefault`, сортировка только по `order`
- Обновлен API `/api/proposals` - автоматически использует основной статус при создании документа
- Обновлен `document-statuses-manager.tsx` - UI с кнопкой установки основного статуса
- Обновлен `proposal-form-v3.tsx` - автоматический выбор основного статуса при создании
- Интеграция toast-уведомлений из библиотеки `sonner`

**Файлы:**
- `prisma/schema.prisma` - добавлено поле `isDefault` в `DocumentStatusType`
- `src/lib/document-status-utils.ts` - новый файл с утилитой получения основного статуса
- `src/app/api/document-statuses/[id]/set-default/route.ts` - новый endpoint
- `src/app/api/document-statuses/route.ts` - возвращает `isDefault`, сортировка по order
- `src/app/api/proposals/route.ts` - использует основной статус при создании
- `src/components/document-statuses-manager.tsx` - UI управления основным статусом, toast
- `src/components/proposal-form-v3.tsx` - автоматический выбор основного статуса
- `src/components/proposal-pdf-preview.tsx` - заменен console.error на logger
- `src/components/parameters-configuration.tsx` - заменен console.* на logger

**Тестирование:**
- ✅ Основной статус устанавливается корректно
- ✅ Основной статус автоматически назначается при создании документа
- ✅ Статусы остаются на своих местах (без перемещения наверх)
- ✅ Toast-уведомления работают корректно
- ✅ Зеленый badge отображается для основного статуса
- ✅ Все console.log заменены на logger

---

## Релиз 1.3.1 - 2025-11-03
**Автор:** MekeidzeRH

**Новые возможности:**
- Расширена цветовая палитра статусов до 26 цветов (было 7)
- Цветные статусы в списке предложений (proposals page)
- Управление статусами: ссылка "+ Gestisci stati" в dropdown статусов
- PDF: данные компании загружаются из `/api/organization`
- PDF: кнопки "Scarica PDF" и "Stampa" отдельно
- PDF: минимальные отступы 5mm для печати
- PDF: компактные итоги по группам (Subtotale gruppo, Sconto, Totale)
- PDF: выделение "Senza IVA" жёлтым фоном в итоговой сумме
- PDF: улучшено качество логотипа при печати (image-rendering: crisp-edges)

**Исправления:**
- Дефолтная ставка НДС берётся из БД (isDefault=true), не hardcoded 22%
- Расчёт НДС 0% ("Senza IVA") работает корректно
- Конвертация Prisma Decimal в number для НДС

**Технические изменения:**
- Обновлена палитра цветов в `document-statuses-manager.tsx` (26 HEX-цветов)
- Инлайн-стили для статусов вместо Tailwind классов
- `ProposalPDFPreview`: fetch `/api/organization` вместо localStorage
- `proposal-pdf-preview.tsx`: кнопки "Scarica PDF" и "Stampa"
- CSS: `@page { margin: 5mm; size: A4 }` для печати
- CSS: `image-rendering: crisp-edges` для логотипов в PDF
- CSS: `print-color-adjust: exact` для точных цветов при печати
- `proposals/page.tsx`: интеграция `statusRef` для цветных бейджей
- `proposal-form-v3.tsx`: конвертация VAT percentage в number

**Файлы:**
- `src/components/document-statuses-manager.tsx` - расширенная палитра
- `src/app/proposals/page.tsx` - цветные статусы
- `src/components/proposal-form-v3.tsx` - ссылка "+ Gestisci stati", конвертация НДС
- `src/components/proposal-pdf-preview.tsx` - данные из БД, кнопки, отступы, итоги, выделение IVA

**Тестирование:**
- ✅ 26 цветов статусов доступны в UI
- ✅ Статусы отображаются цветными в списке предложений
- ✅ PDF использует данные компании из БД
- ✅ Печать с минимальными отступами и A4 размером
- ✅ Дефолтный НДС из БД работает
- ✅ НДС 0% корректно расчитывается
- ✅ Итоги по группам в PDF
- ✅ "Senza IVA" выделен жёлтым в PDF

---

## Релиз 1.3.0 - 2025-11-03
**Автор:** MekeidzeRH

**Новые возможности:**
- Настройки компании теперь хранятся в БД (phone, email, address)
- Умный парсер данных клиента с автоматическим распознаванием:
  - Телефон (с валидацией итальянских номеров +39)
  - Email (с валидацией формата)
  - Имя/Фамилия (с автоисправлением регистра)
  - Компания (для 3+ слов)
- Система статусов документов с привязкой к типам:
  - Типы: Предложения, Заказы, Счета
  - Статусы: Черновик, Отправлено, Утверждено, Отклонено, В производстве, Завершено, Отменено
  - Управление через UI в настройках
  - Цветные бейджи для статусов
- Оптимизированный UI блока итогов в предложениях (компактнее)

**Исправления:**
- Убран hardcode из настроек компании
- Улучшена валидация при создании клиента из предложения
- Статусы предложений теперь загружаются из БД

**Технические изменения:**
- Добавлены поля `phone`, `email`, `address` в модель `Organization`
- Созданы модели `DocumentType`, `DocumentStatus`, `DocumentStatusType`
- Создан `client-input-parser.ts` для умного парсинга
- API: `/api/document-statuses`, `/api/document-types`
- Компонент `document-statuses-manager.tsx` для управления статусами
- Seed-скрипт `seed-document-statuses.ts` для начальных данных

**Файлы:**
- `prisma/schema.prisma` - новые модели и поля
- `prisma/seed-document-statuses.ts` - seed статусов
- `src/app/api/organization/route.ts` - сохранение контактов
- `src/app/api/document-statuses/route.ts` - CRUD статусов
- `src/app/api/document-types/route.ts` - получение типов
- `src/components/general-settings.tsx` - загрузка из БД
- `src/lib/client-input-parser.ts` - парсер клиентов
- `src/components/proposal-form-v3.tsx` - интеграция парсера и статусов
- `src/components/document-statuses-manager.tsx` - UI управления
- `src/components/dictionaries-section.tsx` - добавлена вкладка статусов

**Тестирование:**
- ✅ Сохранение настроек компании в БД
- ✅ Парсинг различных форматов ввода клиента
- ✅ Валидация и автоисправление телефонов
- ✅ Создание и управление статусами документов
- ✅ Отображение статусов в предложениях

---

## Релиз 1.2.0 - 2025-11-02
**Автор:** MekeidzeRH

**Новые возможности:**
- Системные параметры размеров (Ширина, Высота) с автоматическим отображением во всех категориях
- Автоматический расчет площади (м²) в названии товара
- Улучшенное формирование названий товаров:
  - Булевые параметры: "Название: Да/No" с локализацией
  - Размеры: формат "800x2100 мм | 1.68 м²"
  - Остальные параметры: только значение без названия
- Системные налоговые ставки НДС (4%, 5%, 10%, 22%) с защитой от удаления
- Отдельный блок "Размеры" в конфигураторе с визуальным выделением
- Кнопка "Conferma" перенесена в левую панель конфигуратора
- Фиксированные ширины колонок в таблице продуктов (без сжатия при длинном тексте)
- Переносы текста в названиях товаров

**Исправления:**
- Удалена наклейка AUTO из списка товаров
- Исправлена сортировка параметров (Ширина → Высота)
- Исправлена конвертация булевых значений в строки
- Защита системных данных от удаления в UI

**Технические изменения:**
- Добавлено поле `isSystem` в модели `ParameterTemplate` и `VATRate`
- Созданы seed-скрипты: `seed-system-parameters.ts`, `seed-vat-standard.ts`
- Обновлен `product-name-generator.ts` для расчета площади
- Обновлен API `/api/category-parameters` для возврата `isSystem`
- Обновлена сортировка параметров (специальная логика для размеров)

**Файлы:**
- `prisma/schema.prisma` - добавлены поля isSystem
- `prisma/seed-system-parameters.ts` - новый
- `prisma/seed-vat-standard.ts` - новый
- `src/app/api/category-parameters/route.ts` - обновлена сортировка
- `src/components/parameters-configuration.tsx` - блок размеров
- `src/components/proposal-form-v3.tsx` - фиксированные колонки, удалена наклейка
- `src/lib/product-name-generator.ts` - расчет площади, булевые параметры
- `src/components/parameters-manager.tsx` - защита от удаления
- `src/components/vat-rates-manager.tsx` - защита от удаления

**Тестирование:**
- ✅ Системные параметры отображаются во всех категориях
- ✅ Булевые параметры формируются корректно с локализацией
- ✅ Расчет площади работает (мм → м²)
- ✅ Системные данные защищены от удаления
- ✅ UI корректно отображается с фиксированными колонками

---

## Релиз 1.1.0 - 2025-10-15
**Автор:** MekeidzeRH

**Новые возможности:**
- Система предложений (Proposals)
- Конфигуратор продуктов V2
- Генерация PDF документов
- Управление налоговыми ставками

---

## Исправления (2025-01-XX)

### Критические исправления

**1. Исправление НДС (использование справочника вместо хардкода)**
- Проблема: Система игнорировала выбранную дефолтную ставку НДС и всегда использовала хардкод 22%
- Решение: Создана утилита `src/lib/vat-utils.ts` с функцией `getDefaultVatRate()`
- Результат: Система теперь использует дефолтную ставку НДС из справочника (isDefault=true)

**2. PDF генерация и кнопки**
- Проблема: Обе кнопки выполняли одинаковое действие (window.print())
- Решение: "Stampa" → печать, "Scarica PDF" → генерация и скачивание PDF через html2canvas + jsPDF
- Результат: Кнопки работают корректно

**3. Логотип в PDF**
- Проблема: Логотип был слишком большой (h-16 = 64px)
- Решение: Размер уменьшен до h-12 (48px), добавлен imageRendering: 'crisp-edges'
- Результат: Компактный логотип с сохранением качества

**4. Итоги группы в PDF**
- Проблема: Некорректное отображение итогов группы
- Решение: Итого группы размещено в строке названия группы (справа), добавлена разделительная линия
- Результат: Улучшенное отображение итогов в PDF

**5. Выделение "Senza IVA"**
- Решение: В форме итогов и PDF добавлен желтый фон (bg-amber-100) когда vatAmount === 0
- Результат: Явное выделение документов без НДС

**6. Очистка мусора**
- Удалено: 55 файлов .bak из src/lib/i18n.ts.bak*
- Удалено: Старые проекты-бэкапы

**7. Исправления TypeScript ошибок**
- Исправлены типы в clients-sticker-v2.tsx, dictionaries-manager.tsx, document-statuses-manager.tsx и других файлах
- Временно включено ignoreBuildErrors: true в next.config.ts

---

